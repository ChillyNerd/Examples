# Пример организации проекта с подключением к базе через SQLAlchemy

## Цель проекта

Организовать подключение к базе через SQLAlchemy, с возможностью настраивать подключаемую базу через конфигурационный файл.

## Системные требования

Python 3.10.3

Требуемые библиотеки описаны в `requirements.txt`

P.S. Изначально писалось под базу Oracle, поэтому может понадобится instant client для oracle (https://www.oracle.com/database/technologies/instant-client/downloads.html)

## Структура проекта

Работа с базой полностью описывается в пакете db

Пакет db можно разделить на 2 основные части

* Папка schema, где хранятся схемы используемых таблиц
* Класс DB в db_manager.py, через которого к этим схемам происходит обращение

### Как добавить новую схему

1. Создаем новый файл в папке schema
2. Создаем класс по примеру
<pre><code class="shell">from db.schema.base import base

class `Имя обьекта таблицы`(base):
    __tablename__ = '`имя таблицы в базе`'
    __table_args__ = {"schema": "`имя схемы где хранится таблица, если требуется`"}
    id = Column(Integer, primary_key=True)
    ... Описание других колонок
</code></pre>
3. Создаем класс схемы работы с таблицей по примеру
<pre><code class="shell">from db.abstract_db import AbstractDB

class `Имя обьекта схемы работы с таблицей`:
    def __init__(self, db: AbstractDB):
        self.db = db

    def `Имя метода работы с таблицей`(self):
        with self.db.get_session() as session:
            return session.query(...)
</code></pre>
4. Импортируем схему в обьект DB в db_manager.py (обязательно нужно добавить инициализацию схемы в методе prepare)

После добавления схемы в обьект DB, к ней можно обращаться и вызывать написанные методы.

## Примечания

* Перед работой с базой нужно создать сессию. Для этого у класса DB есть метод get_session, который возвращает новую сессию.
* Не забываем про коммиты, если вносите изменения в базу (метод session.commit()). В db.db_manager при инициализации session_maker, можно настроить autocommit, но я ей не доверяю, тк не очень понимаю при каких обстоятельствах происходит коммит.   
* Нужно обязательно закрывать сессию после работы с ней (метод session.close()). Для более удобной работы есть конструкция with - сессия автоматически закроется вне конструкции with

## Пример конфигурационного файла `config.yaml`
<pre><code class="shell">log:
  level: DEBUG

db:
  user: Имя пользователя
  pass: Пароль
  host: Хост СУБД
  port: Порт СУБД
  name: Имя базы
  dll:
    use_external: True # Использовать ли внешние бинарники (может понадобится для cx_Oracle)
    path: Путь до бинарников
</code></pre>
